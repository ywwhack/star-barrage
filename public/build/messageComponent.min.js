var MessageBox=React.createClass({displayName:"MessageBox",getInitialState:function(){return{data:[],orderBy:"time"}},componentDidMount:function(){socket.on("login success",function(data){userInfo=data.user;userInfo.avator="1.png";document.getElementById("login").style.display="none";document.getElementById("container").style.display="block";data.messages=this.howToDisplayData(this.state.orderBy,data.messages);this.setState({data:data.messages})}.bind(this));socket.on("updateList",function(data){data=this.howToDisplayData(this.state.orderBy,data);this.setState({data:data})}.bind(this))},messageSubmit:function(message){socket.emit("add message",message);this.state.data.unshift(message);this.setState({data:this.state.data})},starClick:function(id){var messages=this.state.data;for(var i=0;i<messages.length;i++){if(messages[i]._id==id){var star=messages[i].star;if(star.indexOf(userInfo.uid)>-1)return;messages[i].star.push(userInfo.uid);socket.emit("star",{_id:id,star:messages[i].star});break}}this.setState({data:this.state.data})},howToDisplayData:function(order,data){if(order=="star"){data=data.sort(function(item1,item2){return item2.star.length-item1.star.length})}return data},switchClick:function(order){this.setState({orderBy:order});socket.emit("switch")},render:function(){return React.createElement("div",null,React.createElement(MessageSwitch,{onSwitchClick:this.switchClick}),React.createElement(MessageList,{data:this.state.data,onStarClick:this.starClick}),React.createElement(MessageForm,{onMessageSubmit:this.messageSubmit}))}});var MessageList=React.createClass({displayName:"MessageList",handleClick:function(id){this.props.onStarClick(id)},render:function(){var self=this;var lists=this.props.data.map(function(message,index){return React.createElement("li",{key:index,className:"message"},React.createElement("div",{className:"avator"},React.createElement("img",{src:message.avator})),React.createElement("div",{className:"info"},React.createElement("p",null,message.name),React.createElement("p",null,message.content),React.createElement("p",null,React.createElement("span",{onClick:self.handleClick.bind(self,message._id),className:message.star.indexOf(userInfo.uid)>-1?"star":""},"赞"),React.createElement("span",null,message.star.length?"+"+message.star.length:""))))});return React.createElement("ul",null,lists)}});var MessageForm=React.createClass({displayName:"MessageForm",handleSubmit:function(ev){ev.preventDefault();var content=this.refs.message.getDOMNode().value,message;if(!content)return;message={mid:Date.now(),name:userInfo.name,avator:userInfo.avator,content:content,star:[]};this.props.onMessageSubmit(message);this.refs.message.getDOMNode().value=""},render:function(){return React.createElement("form",{onSubmit:this.handleSubmit},React.createElement("input",{type:"text",ref:"message"}),React.createElement("input",{type:"submit",value:"发送"}))}});var MessageSwitch=React.createClass({displayName:"MessageSwitch",handleSwitch:function(ev){var aLi=this.refs.switch.getDOMNode().children,target=ev.target,order=target.dataset.order;if(target.nodeName=="UL")return;for(var i=0;i<aLi.length;i++){aLi[i].className=""}target.className="active";this.props.onSwitchClick(order)},render:function(){return React.createElement("ul",{className:"switch",onClick:this.handleSwitch,ref:"switch"},React.createElement("li",{className:"active","data-order":"time"},"按时间"),React.createElement("li",{"data-order":"star"},"按赞数"))}});React.render(React.createElement(MessageBox,{pollInterval:50}),document.getElementById("container"));